<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="stock_inv_template">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                    <div class="page">
                        <style>
                            #custom {
                                border: 1px solid black
                                border-collapse: collapse;
                                border-spacing : 0px;
                                border-top-spacing : 0px;
                            }
                            #custom td, #custom th {
                                border: 1px solid black
                            }
                            #custom tr: {
                                border: 1px solid black
                            }
                            #custom th {
                                style="border: 1px solid black"
                            }
                        </style>
                        <br/>
                        <div class="">
                            <t t-foreach="o.warehouse_ids" t-as="warehouse">
                                <br/><br/>
                                <table class="table" id="custom">
                                    <tbody>
                                        <tr style="border-top:2px;">
                                            <th>Company</th>
                                            <th>Warehouse</th>
                                            <th>Location</th>
                                            <th>Date</th>
                                            <th>Generated By</th>
                                            <th>Generated Date</th>
                                        </tr>
                                        <tr>
                                            <td style="border: 1.5px solid black"><span t-field="o.company_id.name"/></td>
                                            <td><span t-esc="warehouse.name"/></td>
                                            <td>
                                                <t t-if="o.location_id">
                                                    <span t-field="o.location_id.name"/>
                                                </t>
                                                <t t-if="not o.location_id">
                                                    <span>All</span>
                                                </t>
                                            </td>
                                            <td><span t-esc="o.start_date"/> To <span t-esc="o.end_date"/></td>
                                            <td><span t-field="user.name"/></td>
                                            <td>
                                                <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d-%m-%Y')"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>

                                <table class="table table-condensed" id="custom">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Beginning</th>
                                            <th>Received</th>
                                            <th>Sales</th>
                                            <th>Internal</th>
                                            <th>Adjustment</th>
                                            <th>Ending</th>
                                        </tr>
                                    </thead>
                                    <tbody class="invoice_tbody">
                                        <t t-set="sum_begning" t-value="0.0"/>
                                        <t t-set="sum_product_qty_in" t-value="0.0"/>
                                        <t t-set="sum_product_qty_out" t-value="0.0"/>
                                        <t t-set="sum_product_qty_internal" t-value="0.0"/>
                                        <t t-set="sum_product_qty_adjustment" t-value="0.0"/>
                                        <t t-if="o.group_by_categ">
                                            <t t-value="get_product_sale_qty(o,product=None,warehouses=warehouse)" t-set="product_val"/>
                                            <t t-foreach="product_val" t-as="product_categ">
                                                <t t-set="sum_categ_begning" t-value="0.0"/>
                                                <t t-set="sum_categ_product_qty_in" t-value="0.0"/>
                                                <t t-set="sum_categ_product_qty_out" t-value="0.0"/>
                                                <t t-set="sum_categ_product_qty_internal" t-value="0.0"/>
                                                <t t-set="sum_categ_product_qty_adjustment" t-value="0.0"/>

                                                <tr style="background-color:darkgrey;">
                                                    <td><span t-esc="request.env['product.category'].browse(product_categ).name"/></td>
                                                    <td colspan="6"/>
                                                </tr>
                                                <t t-foreach="product_categ_value" t-as="product_categ_data">
                                                    <tr>
                                                        <t t-set="product_id" t-value="product_categ_data['product_id']"/>
                                                            <t t-value="get_beginning_inventory(o,product_id,warehouses=warehouse)" t-set="product_beg_qty"/>
                                                            <span t-set="total_ending" t-value=" product_beg_qty + product_categ_data['product_qty_in'] +
                                                                        product_categ_data['product_qty_out'] +
                                                                        product_categ_data['product_qty_internal'] +
                                                                        product_categ_data['product_qty_adjustment']"/>

                                                            <span t-set="today_movment_qty" t-value="product_categ_data['product_qty_in'] +
                                                                        product_categ_data['product_qty_out'] +
                                                                        product_categ_data['product_qty_internal'] +
                                                                        product_categ_data['product_qty_adjustment']"/>
                                                        <t t-if="o.with_zero and not o.is_today_movement">
                                                            <td>
                                                                <span t-esc="request.env['product.product'].browse(product_id).name_get()[0][1]"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_beg_qty"/>
                                                                <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                                <t t-set="sum_categ_begning" t-value="sum_categ_begning + product_beg_qty"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_in']"/>
                                                                <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_categ_data['product_qty_in']"/>
                                                                <t t-set="sum_categ_product_qty_in" t-value="sum_categ_product_qty_in + product_categ_data['product_qty_in']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="abs(product_categ_data['product_qty_out'])"/>
                                                                <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_categ_data['product_qty_out']"/>
                                                                <t t-set="sum_categ_product_qty_out" t-value="sum_categ_product_qty_out + product_categ_data['product_qty_out']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_internal']"/>
                                                                <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_categ_data['product_qty_internal']"/>
                                                                <t t-set="sum_categ_product_qty_internal" t-value="sum_categ_product_qty_internal + product_categ_data['product_qty_internal']"/>

                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_adjustment']"/>
                                                                <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>

                                                                <t t-set="sum_categ_product_qty_adjustment" t-value="sum_categ_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>

                                                            </td>
                                                            <td>
                                                                <span t-esc="product_beg_qty + product_categ_data['product_qty_in'] +
                                                                        product_categ_data['product_qty_out'] +
                                                                        product_categ_data['product_qty_internal'] +
                                                                        product_categ_data['product_qty_adjustment']"/>
                                                            </td>
                                                        </t>
                                                        <t t-if="not o.with_zero and o.is_today_movement and today_movment_qty != 0.00">
                                                            <tr>
                                                                <td>
                                                                    <span t-esc="request.env['product.product'].browse(product_id).name_get()[0][1]"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="product_beg_qty"/>
                                                                    <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                                    <t t-set="sum_categ_begning" t-value="sum_categ_begning + product_beg_qty"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="product_categ_data['product_qty_in']"/>
                                                                    <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_categ_data['product_qty_in']"/>
                                                                    <t t-set="sum_categ_product_qty_in" t-value="sum_categ_product_qty_in + product_categ_data['product_qty_in']"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="abs(product_categ_data['product_qty_out'])"/>
                                                                    <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_categ_data['product_qty_out']"/>
                                                                    <t t-set="sum_categ_product_qty_out" t-value="sum_categ_product_qty_out + product_categ_data['product_qty_out']"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="product_categ_data['product_qty_internal']"/>
                                                                    <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_categ_data['product_qty_internal']"/>
                                                                    <t t-set="sum_categ_product_qty_internal" t-value="sum_categ_product_qty_internal + product_categ_data['product_qty_internal']"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="product_categ_data['product_qty_adjustment']"/>
                                                                    <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>
                                                                    <t t-set="sum_categ_product_qty_adjustment" t-value="sum_categ_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>
                                                                </td>
                                                                <td>
                                                                    <span t-esc="today_movment_qty + product_beg_qty"/>
                                                                </td>
                                                            </tr>
                                                        </t>

                                                        <t t-if="not o.with_zero and not o.is_today_movement and total_ending != 0.00">
                                                            <td>
                                                                <span t-esc="request.env['product.product'].browse(product_id).name_get()[0][1]"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_beg_qty"/>
                                                                <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                                <t t-set="sum_categ_begning" t-value="sum_categ_begning + product_beg_qty"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_in']"/>
                                                                <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_categ_data['product_qty_in']"/>
                                                                <t t-set="sum_categ_product_qty_in" t-value="sum_categ_product_qty_in + product_categ_data['product_qty_in']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="abs(product_categ_data['product_qty_out'])"/>
                                                                <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_categ_data['product_qty_out']"/>
                                                                <t t-set="sum_categ_product_qty_out" t-value="sum_categ_product_qty_out + product_categ_data['product_qty_out']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_internal']"/>
                                                                <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_categ_data['product_qty_internal']"/>
                                                                <t t-set="sum_categ_product_qty_internal" t-value="sum_categ_product_qty_internal + product_categ_data['product_qty_internal']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_categ_data['product_qty_adjustment']"/>
                                                                <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>
                                                                <t t-set="sum_categ_product_qty_adjustment" t-value="sum_categ_product_qty_adjustment + product_categ_data['product_qty_adjustment']"/>
                                                            </td>
                                                            <td>
                                                                <span t-esc="product_beg_qty + product_categ_data['product_qty_in'] +
                                                                        product_categ_data['product_qty_out'] +
                                                                        product_categ_data['product_qty_internal'] +
                                                                        product_categ_data['product_qty_adjustment']"/>
                                                            </td>
                                                        </t>
                                                    </tr>
                                                </t>
                                                <tr>
                                                    <th class="text-center">Total</th>
                                                    <th><span t-esc="sum_categ_begning"/></th>
                                                    <th><span t-esc="sum_categ_product_qty_in"/></th>
                                                    <th><span t-esc="abs(sum_categ_product_qty_out)"/></th>
                                                    <th><span t-esc="sum_categ_product_qty_internal"/></th>
                                                    <th><span t-esc="sum_categ_product_qty_adjustment"/></th>
                                                    <th>
                                                        <span t-esc="sum_categ_begning + sum_categ_product_qty_in + sum_categ_product_qty_out + sum_categ_product_qty_internal
                                                                    + sum_categ_product_qty_adjustment "/>
                                                    </th>
                                                </tr>
                                            </t>
                                        </t>
                                        <t t-if="not o.group_by_categ">
                                            <t t-foreach="get_products(o)" t-as="product">
                                                <t t-set="ending_qty" t-value="0.00"/>
                                                <t t-value="get_beginning_inventory(o,product,warehouses=warehouse)" t-set="product_beg_qty"/>
                                                <t t-value="get_product_sale_qty(o,product,warehouses=warehouse)" t-set="product_val"/>
                                                <t t-set="ending_qty"
                                                   t-value="product_beg_qty + product_val['product_qty_in'] + product_val['product_qty_out'] +
                                                   product_val['product_qty_internal'] + product_val['product_qty_adjustment']
                                                   "/>
                                                   <t t-set="today_movment_qty"
                                                   t-value="product_val['product_qty_in'] + product_val['product_qty_out'] +
                                                   product_val['product_qty_internal'] + product_val['product_qty_adjustment']
                                                   "/>
                                                <t t-if="o.with_zero and not o.is_today_movement">
                                                    <tr>
                                                        <td><span t-esc="product.name_get()[0][1]"/></td>
                                                        <td>
                                                            <span t-esc="product_beg_qty"/>
                                                            <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_in']"/>
                                                            <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_val['product_qty_in']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="abs(product_val['product_qty_out'])"/>
                                                            <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_val['product_qty_out']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_internal']"/>
                                                            <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_val['product_qty_internal']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_adjustment']"/>
                                                            <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_val['product_qty_adjustment']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_beg_qty + product_val['product_qty_in'] +
                                                                    product_val['product_qty_out'] +
                                                                    product_val['product_qty_internal'] +
                                                                    product_val['product_qty_adjustment']"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                                <t t-if=" not o.with_zero and o.is_today_movement and today_movment_qty != 0.00">
                                                    <tr>
                                                        <td><span t-esc="product.name_get()[0][1]"/></td>
                                                        <td>
                                                            <span t-esc="product_beg_qty"/>
                                                            <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_in']"/>
                                                            <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_val['product_qty_in']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="abs(product_val['product_qty_out'])"/>
                                                            <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_val['product_qty_out']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_internal']"/>
                                                            <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_val['product_qty_internal']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_adjustment']"/>
                                                            <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_val['product_qty_adjustment']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="today_movment_qty + product_beg_qty"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                                <t t-if=" not o.with_zero and not o.is_today_movement and ending_qty != 0.00">
                                                    <tr>
                                                        <td><span t-esc="product.name_get()[0][1]"/></td>
                                                        <td>
                                                            <span t-esc="product_beg_qty"/>
                                                            <t t-set="sum_begning" t-value="sum_begning + product_beg_qty"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_in']"/>
                                                            <t t-set="sum_product_qty_in" t-value="sum_product_qty_in + product_val['product_qty_in']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="abs(product_val['product_qty_out'])"/>
                                                            <t t-set="sum_product_qty_out" t-value="sum_product_qty_out + product_val['product_qty_out']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_internal']"/>
                                                            <t t-set="sum_product_qty_internal" t-value="sum_product_qty_internal + product_val['product_qty_internal']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_val['product_qty_adjustment']"/>
                                                            <t t-set="sum_product_qty_adjustment" t-value="sum_product_qty_adjustment + product_val['product_qty_adjustment']"/>
                                                        </td>
                                                        <td>
                                                            <span t-esc="product_beg_qty + product_val['product_qty_in'] +
                                                                    product_val['product_qty_out'] +
                                                                    product_val['product_qty_internal'] +
                                                                    product_val['product_qty_adjustment']"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </t>
                                        </t>
                                    </tbody>
                                    <tr>
                                        <th style="border-top: 2px solid black">Grand Total</th>
                                        <th style="border-top: 2px solid black"><span t-esc="sum_begning"/></th>
                                        <th style="border-top: 2px solid black"><span t-esc="sum_product_qty_in"/></th>
                                        <th style="border-top: 2px solid black"><span t-esc="abs(sum_product_qty_out)"/></th>
                                        <th style="border-top: 2px solid black"><span t-esc="sum_product_qty_internal"/></th>
                                        <th style="border-top: 2px solid black"><span t-esc="sum_product_qty_adjustment"/></th>
                                        <th style="border-top: 2px solid black">
                                            <span t-esc="sum_begning + sum_product_qty_in + sum_product_qty_out + sum_product_qty_internal 
                                                         + sum_product_qty_adjustment "/>
                                        </th>
                                    </tr>
                                </table>
                                <p style="page-break-before:always;"/>
                            </t>
                        </div>
                    </div>
                </t>
                </t>
            </t>
        </template>

    </data>
</odoo>